<!doctype html>

<title>CodeOnion</title>
<meta charset="utf-8"/>

<link rel="stylesheet" href="./lib/codemirror.css">
<link rel="stylesheet" href="./addon/dialog/dialog.css">
<script src="./lib/codemirror.js"></script>
<script src="./addon/dialog/dialog.js"></script>
<script src="./addon/search/searchcursor.js"></script>
<script src="./mode/clike/clike.js"></script>
<script src="./addon/edit/matchbrackets.js"></script>
<script src="./keymap/vim.js"></script>

<article>
<form><textarea id="code" name="code">
#include "syscalls.h"
/* getchar:  simple buffered version */
int getchar(void)
{


  static char buf[BUFSIZ];      

  static      char *bufp = buf;
  static int n = 0;
  if (n == 0) {  /* buffer is empty */
    n = read(0, buf, sizeof buf);
    bufp = buf;
  }
  return (--n >= 0) ? (unsigned char) *bufp++ : EOF;
}
</textarea></form>
<div style="font-size: 13px; width: 300px; height: 30px;">Key buffer: <span id="command-display"></span></div>

<script>
    var i = 0;
    var old_lines = [];
    var new_lines = [];
    var diff_lines = [];

    function getNewLines(lines) {
        var codes_lines = lines.getElementsByClassName("CodeMirror-code");
        var divs = document.getElementByTagName("div");
        for(var i = 0; i < divs.length; i ++) {
            new_lines[i] = divs[i].innerHTML;
        }
    }

    function diffLines(lines1, lines2) {
      
    }


    CodeMirror.commands.save = function(){ alert("Saving"); };
    var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        lineNumbers: true,
        mode: "text/x-csrc",
        keyMap: "vim",
        matchBrackets: true,
        showCursorWhenSelecting: true
    });
    var commandDisplay = document.getElementById('command-display');
    var editorDisplay = document.getElementById("code");
    var keys = '';
    CodeMirror.on(editor, 'vim-keypress', function(key) {
        keys = keys + key;
        commandDisplay.innerHTML = keys;
    });
    CodeMirror.on(editor, 'vim-command-done', function(e) {
        keys = '';
        commandDisplay.innerHTML = keys;
    });

    CodeMirror.on(editor, 'mousedown', function(e) {
        var curPos = editor.getCursor();
        console.log("cur mouse:", curPos);
    });

    window.onOnionUpdate = function() {
        var curPos = editor.getCursor();
        console.log("cur:", curPos);
        var lines = document.getElementsByClassName("CodeMirror-code");
        var divs = lines[0].children;
        console.log(divs[curPos.line].innerHTML);
    }

    window.setInterval(function() {
        i ++;
        if(i >= 0) return;
        var lines = document.getElementsByClassName("CodeMirror-lines");
        var cur_line = editor.getLine(8);
        cur_line = cur_line + "     int;" + "     int;";
        console.log(cur_line);
        editor.setCursor(8, cur_line.length);
        lines[0].innerHTML = lines[0].innerHTML.replace("buf</span>;", "buf</span>;     <span class=\"cm-keyword\">int</span>;");
    }, 50);
</script>

</article>
